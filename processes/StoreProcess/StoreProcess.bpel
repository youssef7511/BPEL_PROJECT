<?xml version="1.0" encoding="UTF-8"?>
<process name="StoreProcess"
         targetNamespace="http://supplychain.example.com/bpel/store"
         xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:tns="http://supplychain.example.com/bpel/store"
         xmlns:store="http://supplychain.example.com/store"
         xmlns:mfg="http://supplychain.example.com/manufacturer"
         xmlns:schema="http://supplychain.example.com/schemas"
         expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"
         queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0">

    <!-- ==================== IMPORTS ==================== -->
    <import namespace="http://supplychain.example.com/store"
            location="../../wsdl/Store.wsdl"
            importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://supplychain.example.com/manufacturer"
            location="../../wsdl/Manufacturer.wsdl"
            importType="http://schemas.xmlsoap.org/wsdl/"/>

    <!-- ==================== PARTNER LINKS ==================== -->
    <partnerLinks>
        <!-- Link client (reçoit startRestock) -->
        <partnerLink name="clientPL"
                     partnerLinkType="store:StorePartnerLT"
                     myRole="storeService"/>

        <!-- Link vers le Manufacturer (invoque requestOrder) -->
        <partnerLink name="manufacturerPL"
                     partnerLinkType="mfg:ManufacturerPartnerLT"
                     partnerRole="manufacturerService"/>

        <!-- Link pour recevoir les callbacks -->
        <partnerLink name="callbackPL"
                     partnerLinkType="store:StorePartnerLT"
                     myRole="storeCallback"/>
    </partnerLinks>

    <!-- ==================== VARIABLES ==================== -->
    <variables>
        <variable name="restockRequest" messageType="store:RestockRequestMessage"/>
        <variable name="orderRequest" messageType="mfg:OrderRequestMessage"/>
        <variable name="manufacturingStatus" messageType="store:ManufacturingStatusMessage"/>
        <variable name="shippingStatus" messageType="store:ShippingStatusMessage"/>
    </variables>

    <!-- ==================== CORRELATION SETS ==================== -->
    <correlationSets>
        <correlationSet name="orderCorrelation" properties="tns:orderId"/>
    </correlationSets>

    <!-- ==================== MAIN SEQUENCE ==================== -->
    <sequence name="MainSequence">

        <!-- 1. Recevoir la demande de réapprovisionnement (client externe) -->
        <receive name="ReceiveRestockRequest"
                 partnerLink="clientPL"
                 portType="store:StorePortType"
                 operation="startRestock"
                 variable="restockRequest"
                 createInstance="yes"/>

        <!-- 2. Préparer la commande pour le Manufacturer -->
        <assign name="PrepareOrderRequest">
            <copy>
                <from>concat('ORD-', $restockRequest.parameters/schema:productId, '-', substring(string(current-dateTime()), 1, 10))</from>
                <to>$orderRequest.parameters/schema:orderId</to>
            </copy>
            <copy>
                <from>$restockRequest.parameters/schema:productId</from>
                <to>$orderRequest.parameters/schema:productId</to>
            </copy>
            <copy>
                <from>$restockRequest.parameters/schema:quantity</from>
                <to>$orderRequest.parameters/schema:quantity</to>
            </copy>
            <copy>
                <from>'123 Rue du Magasin, Paris 75001'</from>
                <to>$orderRequest.parameters/schema:storeAddress</to>
            </copy>
        </assign>

        <!-- 3. Invoquer le Manufacturer (asynchrone) -->
        <invoke name="InvokeManufacturer"
                partnerLink="manufacturerPL"
                portType="mfg:ManufacturerPortType"
                operation="requestOrder"
                inputVariable="orderRequest">
            <correlations>
                <correlation set="orderCorrelation" initiate="yes" pattern="request"/>
            </correlations>
        </invoke>

        <!-- 4. Attendre les deux callbacks en parallèle (FLOW) -->
        <flow name="WaitForCallbacks">

            <!-- Branche 1 : Attendre le statut du Manufacturer -->
            <sequence name="WaitManufacturingStatus">
                <receive name="ReceiveManufacturingStatus"
                         partnerLink="callbackPL"
                         portType="store:StoreCallbackPortType"
                         operation="receiveManufacturingStatus"
                         variable="manufacturingStatus">
                    <correlations>
                        <correlation set="orderCorrelation" initiate="no"/>
                    </correlations>
                </receive>
            </sequence>

            <!-- Branche 2 : Attendre le statut du Shipper -->
            <sequence name="WaitShippingStatus">
                <receive name="ReceiveShippingStatus"
                         partnerLink="callbackPL"
                         portType="store:StoreCallbackPortType"
                         operation="receiveShippingStatus"
                         variable="shippingStatus">
                    <correlations>
                        <correlation set="orderCorrelation" initiate="no"/>
                    </correlations>
                </receive>
            </sequence>

        </flow>

        <!-- 5. Les deux messages reçus : commande terminée -->
        <empty name="OrderComplete"/>

    </sequence>

</process>
